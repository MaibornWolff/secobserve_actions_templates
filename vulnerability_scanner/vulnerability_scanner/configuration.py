import os
import yaml

IMPORTER_VARIABLES = [
    "SO_UPLOAD",
    "SO_API_BASE_URL",
    "SO_PRODUCT_NAME",
    "SO_BRANCH_NAME",
    "SO_ORIGIN_SERVICE",
    "SO_ORIGIN_DOCKER_IMAGE_NAME_TAG",
    "SO_ORIGIN_ENDPOINT_URL",
]

SCANNER_VARIABLES = [
    "TARGET",
    "REPORT_NAME",
    "RUN_DIRECTORY",
    "FURTHER_PARAMETERS",
    "CONFIGURATION",
    "RULES",
    "SCRIPT",
] + IMPORTER_VARIABLES


def get_configuration_from_file() -> dict:
    filename = os.getenv("SO_CONFIGURATION")
    if not filename:
        raise Exception("Environment variable SO_CONFIGURATION not set")

    with open(filename, "r") as yaml_file:
        configuration = yaml.safe_load(yaml_file)
        return configuration


def clean_configuration() -> None:
    for variable in SCANNER_VARIABLES:
        os.environ.pop(variable, None)


def set_importer_configuration(configuration: dict) -> None:
    if configuration.get("importer"):
        importer_configuration = configuration.get("importer")
        for variable in SCANNER_VARIABLES:
            value = importer_configuration.get(variable)
            _set_environment_variable(variable, value)


def set_scanner_configuration(scanner_configuration: dict) -> None:
    for variable in SCANNER_VARIABLES:
        value = scanner_configuration.get(variable)
        _set_environment_variable(variable, value)
        if (
            variable == "RUN_DIRECTORY"
            and os.getenv("RUN_DIRECTORY") is None
        ):
            os.environ["RUN_DIRECTORY"] = "."


def _set_environment_variable(variable, value) -> None:
    if value is not None:
        if value.startswith("$"):
            os.environ[variable] = os.getenv(value[1:])
        else:
            os.environ[variable] = value
